(()=>{"use strict";var t,e={941:()=>{},271:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.generateTerrain=void 0;const n=i(551);function s(t,e,i){for(let s=0;s<t.length-1;s+=e)for(let o=0;o<t.length-1;o+=e){const r=t[o+e]?t[o+e][s+e]:null,a=t[o+e]?t[o+e][s]:null,h=t[o][s],c=t[o][s+e],{count:l,sum:d}=[r,a,h,c].reduce(((t,e)=>(null!=e&&isFinite(e)&&(t.sum+=e,t.count+=1),t)),{sum:0,count:0});t[o+e/2][s+e/2]=d/l+(0,n.randomInRange)(-i,i)}}function o(t,e,i){const s=e/2;for(let o=0;o<t.length;o+=s)for(let r=(o+s)%e;r<t.length;r+=e){const e=t[o+s]?t[o+s][r]:null,a=t[o][r-s],h=t[o-s]?t[o-s][r]:null,c=t[o][r+s],{count:l,sum:d}=[e,a,h,c].reduce(((t,e)=>(null!=e&&isFinite(e)&&(t.sum+=e,t.count+=1),t)),{sum:0,count:0});t[o][r]=d/l+(0,n.randomInRange)(-i,i)}return t}e.generateTerrain=(t,e,i,r,a)=>{const h=function(t,e){let i=t.length-1;for(;i>1;)s(t,i,e),o(t,i,e),i/=2,e/=2;return t}(function(t,e,i){const s=new Array(t).fill(0).map((()=>new Array(t).fill(null)));return s[0][t-1]=(0,n.randomInRange)(e-i,e+i),s[t-1][0]=(0,n.randomInRange)(e-i,e+i),s[0][0]=(0,n.randomInRange)(e-i,e+i),s[t-1][t-1]=(0,n.randomInRange)(e-i,e+i),s}(Math.pow(2,4)+1,i,r),a),c=[];for(let i=0;i<t;i++){c[i]=[];for(let n=0;n<e;n++){const s=Math.floor(i*h.length/t),o=Math.floor(n*h[s].length/e);c[i][n]=h[s][o]}}return c}},760:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.PathFinder=e.NO_PATH=void 0;class i{constructor(){this.tested=!1,this.cost=1/0,this.previous=null}}e.NO_PATH={path:void 0,cost:1/0};e.PathFinder=class{constructor(t,e,i,n){this.graph=t,this.startNode=e,this.endNode=i,this.nodesState=new Map,this.neighbourFilter=n}getNodeState(t){const e=this.graph.getNodeKey(t);let n=this.nodesState.get(e);return n||(n=new i,this.nodesState.set(e,n)),n}find(t=100){const i=this.graph.getNodeKey(this.endNode);let n=this.startNode;this.getNodeState(n).cost=0;const s=[];let o=0;for(;n&&this.graph.getNodeKey(n)!==i&&o<t;){o++;const t=this.getNodeState(n);t.tested=!0;const e=t.cost;let i=this.graph.getNeighbours(n);this.neighbourFilter&&(i=i.filter(this.neighbourFilter.bind(this,n)));for(const t of i){const i=this.getNodeState(t),o=this.graph.costBetween(n,t);i.tested||(i.cost===1/0&&s.push(t),i.cost>e+o&&(i.cost=e+o,i.previous=n))}let r=1/0,a=0;s.forEach(((t,e)=>{const i=this.getNodeState(t).cost+this.graph.distanceBetween(t,this.endNode);r>i&&(r=i,a=e)}));n=s.splice(a,1)[0]}if(n&&o<t){const t=this.getNodeState(n).cost,e=[];e.push(n);let i=this.getNodeState(n);for(;i.previous;)e.unshift(i.previous),i=this.getNodeState(i.previous);return{path:e,cost:t}}return e.NO_PATH}}},551:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.randomInRange=void 0;e.randomInRange=(t,e)=>Math.floor(Math.random()*(e-t+1)+t)},422:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.BowMotion=e.ProjectileMotion=e.GRAVITATIONAL_FORCE_EQUIVALENT=void 0,e.GRAVITATIONAL_FORCE_EQUIVALENT=9.80665;class i{constructor({p0:{x:t,y:i}={x:0,y:0},p1:{x:n,y:s},alpha:o,v0:r,constraints:a=[]}){var h;this.getPoint=t=>{const{V0x:e,V0y:i,G:n,T:s,x0:o,y0:r}=this,a=t*s;return{x:o+e*a,y:r+i*a-n*a*a/2}},this.x0=t,this.y0=i,this.G=e.GRAVITATIONAL_FORCE_EQUIVALENT;const c=n-t,l=s-i,d=new Array(o.divisions).fill(0).map(((t,e)=>o.min+e*(o.max-o.min)/(o.divisions-1)));let u,p=0,g=!1;for(;!g&&p<o.divisions;)g=Math.tan(d[p])>l/c,p++;if(!g)throw new Error("No trajectory possible");do{const e=Math.max(r.min,Math.min(r.max,Math.sqrt(this.G*c*c/(2*(c*Math.tan(d[p])-l)))/Math.cos(d[p])));this.V0x=e*Math.cos(d[p]),this.V0y=e*Math.sin(d[p]),u=null!==(h=null==a?void 0:a.map((({x:e,y:n})=>{const s=e-t;return i+s*Math.tan(d[p])-this.G*s*s/(2*this.V0x*this.V0x)>n})))&&void 0!==h?h:[],p++}while(!u.every((t=>t))&&p<o.divisions);const v=u.findIndex((t=>!t));v>-1?(this.T=(a[v].x-t)/this.V0x,this.reachTarget=!1):(this.T=c/this.V0x,this.reachTarget=!0)}}e.ProjectileMotion=i;e.BowMotion=class extends i{constructor(t,i,s,o){const r=Math.sqrt(e.GRAVITATIONAL_FORCE_EQUIVALENT*i.range.max),a=n(t,i.source,o,3).map((e=>({x:t.world.distanceBetween(s,e),y:e.y-s.y})));super({p1:{x:t.world.distanceBetween(s,o),y:o.y-s.y},alpha:{min:Math.PI/6,max:7*Math.PI/16,divisions:5},v0:{min:0,max:r},constraints:a})}};const n=(t,e,i,n)=>{const s=t.getState(e).position,o=Math.max(Math.abs(i.z-s.z),Math.abs(i.x-s.x)),r=(i.x-s.x)/o,a=(i.z-s.z)/o,h=[];for(let e=1;e<o*n;e++){const i=s.x+e*r/n,o=s.z+e*a/n,c=t.world.getHeight(Math.round(i),Math.round(o));h.push({x:i,y:c,z:o})}return h}},714:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ACTION_CANNOT_REACH_TARGET=e.NO_ACTIVE_PLAYER=e.PLAYER_NOT_ADDED_BEFORE_UNIT=e.UNIT_WITHOUT_STATE=e.UNIT_CANNOT_REACH_POSITION=e.UNIT_CANNOT_MOVE=void 0,e.UNIT_CANNOT_MOVE="Impossible to move unit: cannot move",e.UNIT_CANNOT_REACH_POSITION="Impossible to move unit: unreachable position";e.UNIT_WITHOUT_STATE=t=>`Unit (id=${t.id}) without state`,e.PLAYER_NOT_ADDED_BEFORE_UNIT="Add the player before adding a unit",e.NO_ACTIVE_PLAYER="No active player",e.ACTION_CANNOT_REACH_TARGET="Action impossible: target not in range"},550:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Game=e.GameBuilder=void 0;const n=i(549),s=i(714),o=i(422);e.GameBuilder=class{constructor(t){this.world=t,this.units=[],this.players=[],this.playersUnits=new Map,this.addPlayers=(...t)=>(this.players.push(...t),t.forEach((t=>this.playersUnits.set(t,new Map))),this),this.addUnit=(t,e,i)=>{const{world:n,playersUnits:o,units:r}=this,a=o.get(i);if(!a)throw new Error(s.PLAYER_NOT_ADDED_BEFORE_UNIT);return r.push(t),a.set(t,n.getHeighestPosition(e)),this},this.start=()=>{const{world:t,units:e,playersUnits:i}=this;return new r(t,e,i)}}};class r{constructor(t,e,i){this.world=t,this.units=e,this.unitsState=new Map,this.playersUnits=new Map,this.unitPlayer=new Map,this.activeUnitIndex=0,this.getActiveUnit=()=>this.units[this.activeUnitIndex],this.getActivePlayer=()=>this.getPlayer(this.getActiveUnit()),this.getPlayer=t=>{const e=this.unitPlayer.get(t);if(!e)throw new Error(s.NO_ACTIVE_PLAYER);return e},this.getPotentialTargets=t=>{const e=this.getPlayer(t);return Array.from(this.playersUnits.entries()).filter((t=>t[0]!==e)).map((t=>t[1])).reduce(((t,e)=>{const i=t;return i.push(...e.filter((t=>!this.getState(t).dead))),i}),[])},this.getStates=t=>{const e=this.unitsState.get(t);if(!e)throw new Error((0,s.UNIT_WITHOUT_STATE)(t));return e},this.getState=t=>{const e=this.getStates(t);return e[e.length-1]},this.getPositions=()=>Array.from(this.unitsState.values()).map((t=>{return(e=t,e[e.length-1]).position;var e})),this.getUnits=t=>{const{units:e,getState:i}=this;return e.filter((e=>{const n=i(e).position;return!!n&&t.find((t=>n.x===t.x&&n.z===t.z))}))},this.nextTurn=()=>{const{getActiveUnit:t,getStates:e,getState:i}=this,n=t();e(n).push(i(n).endTurn());if(Array.from(this.playersUnits.entries()).filter((t=>t[1].find((t=>!i(t).dead))||!1)).length<2)throw new Error("Game is over");let s=0;do{this.activeUnitIndex=(this.activeUnitIndex+1)%this.units.length,s++}while(s<this.units.length&&this.getState(this.getActiveUnit()).dead);const o=this.getActiveUnit();this.getStates(o).push(this.getState(o).startTurn())},this.getPosition=t=>{var e;const i=null===(e=this.getState(t))||void 0===e?void 0:e.position;if(!i)throw new Error(`Unit (id=${t.id}) without position`);return i},this.moveUnit=(t,e)=>{const{world:i,getReachablePositions:n,getPosition:o}=this;if(!this.getState(t).canMove)throw new Error(s.UNIT_CANNOT_MOVE);const r=o(t),c=i.getHeighestPosition(e);if(!a(e,n(t)))throw new Error(s.UNIT_CANNOT_REACH_POSITION);const l=i.getShortestPath(r,c,h(t.jump,this.getPositions())).find();if(l.path){const e=this.getState(t);this.getStates(t).push(e.moveTo(c))}return l.path},this.previewAction=(t,e)=>{const{getReachablePositionsForAction:i,getState:n,getUnits:o}=this;if(!a(e,i(t)))throw new Error(s.ACTION_CANNOT_REACH_TARGET);const r=c(this,t,this.world.getHeighestPosition(e)),h=!r||r.reachTarget,l=new Map;return h&&o([e]).forEach((e=>l.set(e,t.modify(n(e))))),l.set(t.source,(l.get(t.source)||n(t.source)).act()),{newStates:l,trajectory:r}},this.executeAction=(t,e)=>{const{previewAction:i,getStates:n}=this,s=i(t,e);return s.newStates.forEach(((t,e)=>n(e).push(t))),s},this.getReachablePositionsForAction=(t,e)=>{const{world:i,getPosition:n}=this;let s=null!=e?e:n(t.source);return i.getNodesAccessibleByFlight(s,t.range.min,t.range.max,h(t.range.vMax,[]))},this.getReachablePositions=t=>{const{world:e,getPosition:i,getPositions:n}=this;let s=i(t);return e.getAccessibleNodes(s,1,t.moves,h(t.jump,n()))},i.forEach(((t,e)=>{this.playersUnits.set(e,Array.from(t.keys())),t.forEach(((t,i)=>{this.unitsState.set(i,[n.UnitState.init(i,t)]),this.unitPlayer.set(i,e)}))}));const o=this.getActiveUnit(),r=this.getState(o);this.getStates(o).shift(),this.getStates(o).push(r.startTurn())}}e.Game=r;const a=(t,e)=>e.find((e=>e.x===t.x&&e.z===t.z)),h=(t,e)=>(i,n)=>!e.find((t=>t.x===n.x&&t.z===n.z))&&Math.abs(n.y-i.y)<=t,c=(t,e,i)=>{if(!e.trajectory)return;const n=t.getState(e.source).position;return"bow"===e.trajectory?new o.BowMotion(t,e,n,i):void 0}},549:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.AttackAction=e.UnitState=e.Unit=void 0;const n=i(565);e.Unit=class{constructor(t){var e;this.id=t.id,this.type=t.type,this.name=t.name,this.moves=t.moves,this.jump=t.jump,this.hp=t.hp,this.weapon=null!==(e=t.weapon)&&void 0!==e?e:(0,n.FISTS)(1)}};class s{constructor({hp:t,position:e,canMove:i,canAct:n,dead:o}){this.moveTo=t=>new s({hp:this.hp,position:t,canMove:!1,canAct:this.canAct,dead:this.dead}),this.act=()=>new s({hp:this.hp,position:this.position,canMove:this.canMove,canAct:!1,dead:this.dead}),this.modify=t=>new s({hp:this.hp+t,position:this.position,canMove:this.canMove,canAct:this.canAct,dead:this.dead||this.hp+t<=0}),this.startTurn=()=>new s({hp:this.hp,position:this.position,canMove:!0,canAct:!0,dead:this.dead}),this.endTurn=()=>new s({hp:this.hp,position:this.position,canMove:!1,canAct:!1,dead:this.dead}),this.hp=t,this.position=e,this.canMove=i,this.canAct=n,this.dead=o}}e.UnitState=s,s.init=(t,e)=>new s({hp:t.hp,position:e,canMove:!1,canAct:!1,dead:!1});e.AttackAction=class{constructor(t){this.modify=t=>t.modify(-this.source.weapon.power),this.source=t}get range(){return this.source.weapon.range}get trajectory(){return this.source.weapon.trajectory}}},565:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.BOW=e.FISTS=void 0;const n=i(422);e.FISTS=t=>({range:{min:1,max:1,vMax:1},power:t,area:1});e.BOW=(t,e,i)=>({range:{min:t,max:e,vMax:e*e/(2*n.GRAVITATIONAL_FORCE_EQUIVALENT)},power:1,area:1,trajectory:"bow"})},712:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.WorldMap=e.ProjectileGraph=void 0;const n=i(760),s=i(551),o=(t,e,i,n)=>{let s=t.getNeighbours(e);return n&&(s=s.filter((t=>n(e,t)))),s.map((n=>({node:n,cost:i+t.costBetween(e,n)})))};class r{constructor(t){this.graph=t,this.costBetween=(t,e)=>this.graph.distanceBetween(t,e),this.distanceBetween=(t,e)=>this.graph.distanceBetween(t,e),this.getNeighbours=t=>this.graph.getNeighbours(t),this.getNodeKey=t=>this.graph.getNodeKey(t)}}e.ProjectileGraph=r;e.WorldMap=class{constructor(t,e=0){this.chunkSize=t,this.waterLevel=e,this.voxelCostMap=new Map,this.getClosestPositionInWorld=({x:t,z:e})=>{const i=Math.floor(t),n=Math.floor(e);return{x:i,y:this.getHeight(i,n),z:n}},this.getNeighbours=({x:t,z:e})=>{const{getVoxel:i,getHeight:n}=this;return[{x:t-1,y:n(t-1,e),z:e},{x:t+1,y:n(t+1,e),z:e},{x:t,y:n(t,e-1),z:e-1},{x:t,y:n(t,e+1),z:e+1}].filter((t=>0!==i({x:t.x,y:t.y-1,z:t.z})))},this.costBetween=(t,e)=>e.y<this.waterLevel?99:e.y===this.waterLevel?2:this.voxelCostMap.get(this.getVoxel(e))||1,this.distanceBetween=({x:t,z:e},{x:i,z:n})=>Math.sqrt((i-t)*(i-t)+(n-e)*(n-e)),this.getNodeKey=({x:t,y:e,z:i})=>{const{chunkSize:n,chunkSliceSize:s}=this;return(e%n|0)*s+(i%n|0)*n+(t%n|0)},this.setVoxel=(t,e)=>{const{chunk:i}=this;i[this.getNodeKey(t)]=e},this.fillCostMap=t=>t.forEach(((t,e)=>this.voxelCostMap.set(e,t))),this.getVoxel=t=>{const{chunk:e,chunkSize:i,getNodeKey:n}=this;if(t.x<0||t.z<0||t.x>=i||t.z>=i)return 0;return e[n(t)]},this.getHeight=(t,e)=>{const{chunk:i}=this;let n=0,s=0;for(;n<this.chunkSize;){i[this.getNodeKey({x:t,y:n,z:e})]>0&&(s=n),n++}return s+1},this.getHeighestPosition=({x:t,z:e})=>({x:t,y:this.getHeight(t,e),z:e}),this.getRandomPosition=(t,e,i,n)=>{const o=[];for(let s=t;s<i;s++)for(let t=e;t<n;t++){this.getHeight(s,t)>=this.waterLevel&&o.push({x:s,z:t})}if(0===o.length)throw new Error("No valid position available");return o[(0,s.randomInRange)(0,o.length-1)]},this.chunkSliceSize=t*t,this.chunk=new Uint8Array(t*t*t),this.projectileGraph=new r(this)}getShortestPath(t,e,i){return new n.PathFinder(this,t,e,i)}getAccessibleNodes(t,e,i,n){const s=[],r=[],a=[{node:t,cost:0}];for(;a.length>0;){const t=a.shift(),h=this.getNodeKey(t.node),c=r.find((t=>h===this.getNodeKey(t)));if(t.cost<=i&&!c){r.push(t.node),t.cost>=e&&s.push(t.node);const i=o(this,t.node,t.cost,n);a.push(...i)}0}return s}getNodesAccessibleByFlight(t,e,i,n){const{projectileGraph:s}=this,r=[],a=[],h=[{node:t,cost:0}];for(;h.length>0;){const c=h.shift(),l=s.getNodeKey(c.node),d=a.find((t=>l===s.getNodeKey(t))),u=s.distanceBetween(t,c.node);if(u<=i&&!d){a.push(c.node),u>=e&&r.push(c.node);const t=o(s,c.node,u,n);h.push(...t)}0}return r}}},725:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.IAService=void 0;const n=i(549),s=i(422),o=(t,e,i,n)=>{const s=e.world.distanceBetween(n,i);return s>=t.range.min&&s<=t.range.max&&Math.abs(i.y-n.y)<=t.range.vMax};e.IAService=class{computeBestTurnActions(t,e){const i=t.getReachablePositions(e),r=t.getPotentialTargets(e),a=((t,e,i,n)=>n.find((n=>{const s=i.getState(n);return!s.dead&&e.findIndex(o.bind(null,t.weapon,i,s.position))>-1})))(e,i,t,r)||r.find((()=>!0));switch(e.type){case"warrior":case"archer":const r=[];if(a){const h=t.getState(a).position;let c=t.getState(e).position;if(i.length>0&&!o(e.weapon,t,c,h)&&(c=((t,e,i,n)=>{const s=n.getState(i).position;if(0===e.length)throw new Error("No accessible position available");return e.map((e=>({d:n.world.distanceBetween(e,s),withinWeaponRange:o(t.weapon,n,e,s),p:e}))).reduce(((e,i)=>(null==e?void 0:e.withinWeaponRange)?e:(null==e?void 0:e.d)&&e.d-t.weapon.range.max>0?e.d<i.d?e:i:(null==e?void 0:e.d)&&e.d-t.weapon.range.min<0&&e.d&&(null==e?void 0:e.d)>i.d?e:i)).p})(e,i,a,t),r.push({type:"move",position:{x:c.x,y:c.y,z:c.z}})),o(e.weapon,t,c,h)){const i=new n.AttackAction(e);("bow"!==i.trajectory||new s.BowMotion(t,i,c,h).reachTarget)&&r.push({type:"attack",action:i,position:{x:h.x,y:h.y,z:h.z}})}}return{actions:r.values()}}}}},607:(t,e,i)=>{const n=i(212),s=i(228),o=i(332),r=i(485),a=i(359),h=i(365),c=i(550),l=i(436),d=i(549),u=i(565),p=i(421),g=i(295),v=i(99),m=i(981);const w=(t,e)=>{t.update(e)},f=t=>{const e=new n.WebGLRenderer;e.setPixelRatio(window.devicePixelRatio),e.setSize(window.innerWidth,window.innerHeight),e.toneMapping=n.ACESFilmicToneMapping,e.toneMappingExposure=.5;const i=e.domElement;document.body.append(i);const s=new n.PerspectiveCamera(75,2,1,2e4);s.position.set(.3*-t,.8*t,.3*-t);const o=new h.OrbitControls(s,i);return o.target.set(t/2,t/3,t/2),o.update(),new g.SceneContext(e,s,o,new n.Raycaster)},y=t=>{const e=new r.BasicWorldMapGenerator(t,t,8).generate(),i={id:1,name:"P1",color:"#ff0000",mode:"human"},n={id:2,name:"P2",color:"#00ff00",mode:"ia"};let s=0;return new c.GameBuilder(e).addPlayers(i,n).addUnit(new d.Unit({id:s++,type:"warrior",name:"Knight "+s,moves:5,jump:1,hp:10}),e.getRandomPosition(0,0,t-1,t-1),i).addUnit(new d.Unit({id:s++,type:"warrior",name:"Knight "+s,moves:8,jump:1,hp:10}),e.getRandomPosition(0,0,t-1,t-1),i).addUnit(new d.Unit({id:s++,type:"warrior",name:"Knight "+s,moves:8,jump:1,hp:10}),e.getRandomPosition(0,0,t-1,t-1),i).addUnit(new d.Unit({id:s++,type:"archer",name:"Knight "+s,moves:8,jump:1,hp:10,weapon:(0,u.BOW)(3,10,1)}),e.getRandomPosition(0,0,t-1,t-1),i).addUnit(new d.Unit({id:s++,type:"archer",name:"Archer "+s,moves:7,jump:2,hp:10,weapon:(0,u.BOW)(3,10,1)}),e.getRandomPosition(0,0,t-1,t-1),n).addUnit(new d.Unit({id:s++,type:"archer",name:"Archer "+s,moves:7,jump:2,hp:10,weapon:(0,u.BOW)(3,10,1)}),e.getRandomPosition(0,0,t-1,t-1),n).start()};!function(){const t=new n.Clock,e=f(16),i=(0,l.loadImprovedTexture)(A),r=y(16),h=new n.Scene,c=new s.GameView(h,e,i);c.generateChunk(r.world),c.generateUnits(r);const d=new o.MainScene(h,e);d.addWater(r.world.waterLevel),d.addSky();const u=new v.GameManager(r,c),g=new p.TacticalGUI(e.camera,u);function A(){requestAnimationFrame(A);const i=t.getDelta();d.update(i),c.update(i),e.renderer.render(h,e.camera)}u.register("stateChanged",(t=>w(g,t))),u.handleEvent(new m.UnitSelectionEvent(r.getActiveUnit())),e.renderer.domElement.addEventListener("mousedown",(t=>{if(0!==t.button)return;const{camera:i,raycaster:n}=e,s={x:t.clientX/window.innerWidth*2-1,y:-t.clientY/window.innerHeight*2+1};n.setFromCamera(s,i);const o=n.intersectObjects(h.children,!0);if(o.length>0){const t=c.getTarget(r,o);(null==t?void 0:t.position)&&u.handleEvent(new m.PositionSelectionEvent(t.position)),(null==t?void 0:t.unit)&&u.handleEvent(new m.UnitSelectionEvent(t.unit))}}),!1),(0,a.stats)(),A()}(),"serviceWorker"in navigator&&window.addEventListener("load",(()=>{navigator.serviceWorker.register("/service-worker.js").then((t=>{})).catch((t=>{}))}))},421:function(t,e,i){var n=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{h(n.next(t))}catch(t){o(t)}}function a(t){try{h(n.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}h((n=n.apply(t,e||[])).next())}))},s=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.TacticalGUI=void 0;const o=s(i(637)),r=i(212),a=i(981),h=i(339);e.TacticalGUI=class{constructor(t,e){this.camera=t,this.gameManager=e,this.unselectUnit=()=>{var t,e;null===(t=this.unitGUI)||void 0===t||t.destroy(),null===(e=this.actionsGUI)||void 0===e||e.destroy()},this.move=()=>n(this,void 0,void 0,(function*(){yield this.gameManager.handleEvent(new a.ActionEvent("move"))})),this.attack=()=>n(this,void 0,void 0,(function*(){yield this.gameManager.handleEvent(new a.ActionEvent("attack"))})),this.endTurn=()=>n(this,void 0,void 0,(function*(){yield this.gameManager.handleEvent(new a.ActionEvent("end"))})),this.showUnitState=(t,e)=>{var i,n;t&&(null===(i=this.unitGUI)||void 0===i||i.destroy(),this.unitGUI=new o.default({title:t.name}),null===(n=this.unitGUI)||void 0===n||n.domElement.style.setProperty("top","20px"),this.unitGUI.add(t,"jump"),this.unitGUI.add(t,"moves"),this.unitGUI.add(e,"hp",0,t.hp),this.unitGUI.add(e.position,"x"),this.unitGUI.add(e.position,"y"),this.unitGUI.add(e.position,"z"))},this.showUnitActions=(t,e)=>{var i,n,s,r,a;e&&(null===(i=this.actionsGUI)||void 0===i||i.destroy(),this.actionsGUI=new o.default({title:"Actions"}),null===(n=this.actionsGUI)||void 0===n||n.domElement.style.setProperty("top","250px"),t.canMove&&(null===(s=this.actionsGUI)||void 0===s||s.add(this,"move").name("Move")),t.canAct&&(null===(r=this.actionsGUI)||void 0===r||r.add(this,"attack").name("Attack")),null===(a=this.actionsGUI)||void 0===a||a.add(this,"endTurn").name("End turn"))},this.scene=new r.Scene,this.actionsGUI=new o.default({title:"Actions"})}update(t){if(t instanceof h.UnitSelectedState){const e=t.selectedUnit,i=t.game.getState(e);this.showUnitState(e,i),this.showUnitActions(i,e===t.game.getActiveUnit())}t.name===a.STATES.NOTHING_SELECTED&&this.unselectUnit()}}},99:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.GameManager=void 0;const n=i(724);e.GameManager=class{constructor(t,e){this.game=t,this.gameView=e,this.callbacks=new Map,this.frozen=!1,this.handleEvent=t=>this.frozen?Promise.resolve(this.gameState):(this.frozen=!0,this.gameState.handleEvent(t).then((t=>(this.gameState=t,this.frozen=!1,this.dispatch("stateChanged",t),t)))),this.register=(t,e)=>{var i;this.callbacks.has(t)||this.callbacks.set(t,[]),null===(i=this.callbacks.get(t))||void 0===i||i.push(e)},this.dispatch=(t,...e)=>{var i;return null===(i=this.callbacks.get("stateChanged"))||void 0===i?void 0:i.forEach((t=>t(...e)))},this.gameState=new n.NothingSelectedState(t,e)}}},677:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.GameState=void 0;e.GameState=class{constructor(t,e,i){this.game=t,this.gameView=e,this.name=i,this.handleEvent=t=>Promise.resolve(this)}}},28:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ActionPreviewedState=void 0;const n=i(981),s=i(677),o=i(724),r=i(339);class a extends s.GameState{constructor(t,e,i,s){super(t,e,n.STATES.ACTION_PREVIEWED),this.selectedUnit=i,this.selectedAction=s,this.handleEvent=t=>{if(t instanceof n.CancelEvent)return this.gameView.unselect(),Promise.resolve(new o.NothingSelectedState(this.game,this.gameView));if(t instanceof n.PositionSelectionEvent){const e=this.game.executeAction(this.selectedAction,t.position),i=this.game.getState(this.selectedUnit);return this.gameView.executeAction(this.selectedUnit,i,e,t.position).then((()=>new r.UnitSelectedState(this.game,this.gameView,this.selectedUnit)))}return Promise.resolve(this)}}}e.ActionPreviewedState=a},220:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ActionTargetSelectionState=void 0;const n=i(981),s=i(677),o=i(28),r=i(724);class a extends s.GameState{constructor(t,e,i,s){super(t,e,n.STATES.ACTION_TARGET_SELECTION),this.selectedUnit=i,this.selectedAction=s,this.handleEvent=t=>{if(t instanceof n.UnitSelectionEvent)return this.selectedUnit===t.unit?(this.gameView.unselect(),Promise.resolve(new r.NothingSelectedState(this.game,this.gameView))):Promise.resolve(this);if(t instanceof n.PositionSelectionEvent){const e=this.game.previewAction(this.selectedAction,t.position),i=this.game.getState(this.selectedUnit);return this.gameView.previewAction(this.selectedUnit,i,e,t.position),Promise.resolve(new o.ActionPreviewedState(this.game,this.gameView,this.selectedUnit,this.selectedAction))}return Promise.resolve(this)}}}e.ActionTargetSelectionState=a},896:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.MoveSelectionState=void 0;const n=i(981),s=i(677),o=i(724),r=i(339);class a extends s.GameState{constructor(t,e,i){super(t,e,n.STATES.MOVE_SELECTION),this.selectedUnit=i,this.handleEvent=t=>{if(t instanceof n.UnitSelectionEvent)return this.selectedUnit===t.unit?(this.gameView.unselect(),Promise.resolve(new o.NothingSelectedState(this.game,this.gameView))):Promise.resolve(this);if(t instanceof n.PositionSelectionEvent){const e=this.game.moveUnit(this.selectedUnit,t.position);return e?this.gameView.moveSelectedUnitAlong(this.selectedUnit,this.game.getState(this.selectedUnit),e).then((()=>new r.UnitSelectedState(this.game,this.gameView,this.selectedUnit))):Promise.reject(`Impossible to move unit (id=${this.selectedUnit.id}) to ${t.position} : no path found`)}return Promise.resolve(this)}}}e.MoveSelectionState=a},724:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.NothingSelectedState=void 0;const n=i(981),s=i(677),o=i(339);class r extends s.GameState{constructor(t,e){super(t,e,n.STATES.NOTHING_SELECTED),this.handleEvent=t=>t instanceof n.UnitSelectionEvent?(this.gameView.select(t.unit,this.game.getState(t.unit).position),Promise.resolve(new o.UnitSelectedState(this.game,this.gameView,t.unit))):Promise.resolve(this)}}e.NothingSelectedState=r},339:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.UnitSelectedState=void 0;const n=i(549),s=i(981),o=i(677),r=i(724),a=i(896),h=i(220),c=i(221),l=i(725);class d extends o.GameState{constructor(t,e,i){super(t,e,s.STATES.UNIT_SELECTED),this.selectedUnit=i,this.iaManager=new c.IAManager(new l.IAService,500),this.handleEvent=t=>t instanceof s.UnitSelectionEvent?t.unit===this.selectedUnit?(this.gameView.unselect(),Promise.resolve(new r.NothingSelectedState(this.game,this.gameView))):Promise.resolve(this):t instanceof s.ActionEvent?this.handleActionEvent(t):Promise.resolve(this),this.handleActionEvent=t=>{if("move"===t.action){const t=this.game.getReachablePositions(this.selectedUnit);return this.gameView.selectMoveAction(this.selectedUnit,t),Promise.resolve(new a.MoveSelectionState(this.game,this.gameView,this.selectedUnit))}if("attack"===t.action){const t=new n.AttackAction(this.selectedUnit),e=this.game.getReachablePositionsForAction(t);return this.gameView.selectAction(this.selectedUnit,e),Promise.resolve(new h.ActionTargetSelectionState(this.game,this.gameView,this.selectedUnit,t))}if("end"===t.action){this.game.nextTurn();const t=this.game.getActiveUnit();return"ia"===this.game.getActivePlayer().mode?this.iaManager.handleTurn(this.game,this.gameView):(this.gameView.unselect(),this.gameView.select(t,this.game.getState(t).position),Promise.resolve(new d(this.game,this.gameView,t)))}return Promise.resolve(this)}}}e.UnitSelectedState=d},981:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ActionEvent=e.CancelEvent=e.PositionSelectionEvent=e.UnitSelectionEvent=e.GameInputEvent=e.STATES=void 0,e.STATES={NOTHING_SELECTED:"NOTHING_SELECTED",UNIT_SELECTED:"UNIT_SELECTED",ACTION_TARGET_SELECTION:"ACTION_TARGET_SELECTION",ACTION_PREVIEWED:"ACTION_PREVIEWED",MOVE_SELECTION:"MOVE_SELECTION",WAITING:"WAITING"};class i{constructor(t){this.name=t}}e.GameInputEvent=i;e.UnitSelectionEvent=class extends i{constructor(t){super("UnitSelectionEvent"),this.unit=t}};e.PositionSelectionEvent=class extends i{constructor(t){super("PositionSelectionEvent"),this.position=t}};e.CancelEvent=class extends i{constructor(){super("CancelEvent")}};e.ActionEvent=class extends i{constructor(t){super("ActionEvent"),this.action=t}}},359:function(t,e,i){var n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.stats=void 0;const s=n(i(79));e.stats=()=>{let t=(0,s.default)();t.showPanel(0),document.body.appendChild(t.dom),requestAnimationFrame((function e(){t.begin(),t.end(),requestAnimationFrame(e)}))}},295:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.SceneContext=void 0;const n=i(212);e.SceneContext=class{constructor(t,e,i,s){this.renderer=t,this.camera=e,this.controls=i,this.raycaster=s,this.pmremGenerator=new n.PMREMGenerator(t)}get canvas(){return this.renderer.domElement}}},228:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.GameView=void 0;const n=i(212),s=i(927),o=i(436),r=i(193),a=i(479),h=[[0,0,0],[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]];e.GameView=class{constructor(t,e,i){this.context=e,this.textureInfos=i,this.unitsToMesh=new Map,this.generateUnits=t=>{const{unitLayer:e,unitsToMesh:i}=this;t.playersUnits.forEach(((n,o)=>{n.forEach((n=>{const r=t.getPosition(n);if(r){const t=(0,s.initUnit)(n,r,o);t.idle.play(),e.add(t.mesh),i.set(n,t)}}))}))},this.update=t=>{Array.from(this.unitsToMesh.values()).forEach((e=>e.update(t))),this.trajectoryView.update(t)},this.getUnitViewFromUnit=t=>{const e=this.unitsToMesh.get(t);if(!e)throw new Error(`Unit ${t} has no mesh`);return e},this.getTarget=(t,e)=>{const i=e.map((t=>Array.from(this.unitsToMesh.values()).find((e=>e.childrenIds.indexOf(t.object.uuid)>0)))).find((t=>null!=t));return i?{unit:i.unit}:e.length>0?{position:t.world.getClosestPositionInWorld({x:e[0].point.x,z:e[0].point.z})}:void 0},this.moveSelectedUnitAlong=(t,e,i)=>{const{rangeView:n,select:s,getUnitViewFromUnit:o}=this;n.clear(),s(t,e.position);return o(t).startMovingToward(i,5)},this.previewAction=(t,e,i,n)=>{const{rangeView:s,trajectoryView:o,getUnitViewFromUnit:r}=this,h=r(t);i.trajectory&&o.draw(h,(0,a.toVector3)(n),i.trajectory),s.clear(),s.draw(h.player.color,[e.position]),s.draw("#000000",[n])},this.executeAction=(t,e,i,n)=>{const{rangeView:s,trajectoryView:o,select:r,getUnitViewFromUnit:h}=this;i.newStates.forEach(((t,e)=>{if(t.dead){h(e).die()}})),s.clear(),r(t,e.position);return h(t).startAttacking((0,a.toVector3)(n),o,1).then((()=>{o.clear()}))},this.selectMoveAction=(t,e)=>{const{rangeView:i,getUnitViewFromUnit:n}=this,s=n(t);i.draw(s.player.color,e)},this.selectAction=(t,e)=>{const{rangeView:i,getUnitViewFromUnit:n}=this,s=n(t);i.draw(s.player.color,e)},this.select=(t,e)=>{const i=this.getUnitViewFromUnit(t);this.rangeView.draw(i.player.color,[e])},this.unselect=()=>{this.trajectoryView.clear(),this.rangeView.clear()},this.parent=new n.Group,t.add(this.parent),this.unitLayer=new n.Group,this.unitLayer.position.set(.5,0,.5),this.parent.add(this.unitLayer),this.rangeView=new r.RangeView(this.parent),this.trajectoryView=new r.TrajectoryView,this.worldMesh=new n.Mesh(new n.BufferGeometry,this.textureInfos.material),this.parent.add(this.worldMesh),this.worldMesh.position.set(0,0,0)}generateChunk(t){const{chunkSize:e,getVoxel:i}=t,{textureInfos:n}=this,s=new Map;for(const t of h){const r=t[0],a=t[1],h=t[2],c="1";s.get(c)||(s.set(c,!0),(0,o.updateChunkGeometry)(r,a,h,e,this.worldMesh,n,i))}}}},221:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.IAManager=void 0;const n=i(479),s=i(981),o=i(724);e.IAManager=class{constructor(t,e){this.iaPort=t,this.delayDuration=e,this.handleTurn=(t,e)=>{const i=t.getActiveUnit(),n=this.iaPort.computeBestTurnActions(t,i),s=new o.NothingSelectedState(t,e);return this.handleAction(s,n.actions)},this.handleAction=(t,e)=>{const{handleAction:i}=this,o=e.next();if(o.done)return t.handleEvent(new s.ActionEvent("end"));{const r=o.value,a=new s.PositionSelectionEvent(r.position);return"move"===r.type?t.handleEvent(new s.ActionEvent("move")).then((t=>(0,n.delay)(t,this.delayDuration))).then((t=>t.handleEvent(a))):"attack"===r.type&&r.action?t.handleEvent(new s.ActionEvent("attack")).then((t=>(0,n.delay)(t,this.delayDuration))).then((t=>t.handleEvent(a))).then((t=>(0,n.delay)(t,this.delayDuration))).then((t=>t.handleEvent(a))).then((()=>i(t,e))):i(t,e)}}}}},332:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.MainScene=void 0;const n=i(212),s=i(660),o=i(644),r=i(471);e.MainScene=class{constructor(t,e){this.scene=t,this.context=e;const i=document.createElement("div");i.className="action",i.textContent="PLOP";const n=new r.CSS3DObject(i);n.position.set(0,0,0),t.add(n)}addWater(t=0){this.waterView=new a(this.scene,t)}addSky(){this.skyView=new h(this.scene,this.context.renderer,this.context.pmremGenerator,{elevation:10}),this.skyView.applyConfiguration()}update(t){var e,i;null===(e=this.waterView)||void 0===e||e.update(t,null===(i=this.skyView)||void 0===i?void 0:i.sun),this.context.controls.update()}};class a{constructor(t,e=0){const i=new n.PlaneGeometry(1e3,1e3);this.water=new s.Water(i,{textureWidth:512,textureHeight:512,waterNormals:(new n.TextureLoader).load("images/waternormals.jpg",(function(t){t.wrapS=t.wrapT=n.RepeatWrapping})),sunDirection:new n.Vector3,sunColor:16777215,waterColor:7695,distortionScale:3.7,fog:void 0!==t.fog}),this.water.rotation.x=-Math.PI/2,this.water.position.y=e+.5,t.add(this.water)}update(t,e){e&&this.water.material.uniforms.sunDirection.value.copy(e).normalize(),this.water.material.uniforms.time.value+=.1*t}}class h{constructor(t,e,i,s){this.scene=t,this.renderer=e,this.pmremGenerator=i,this.sun=new n.Vector3,this.sky=new o.Sky,this.updateConfiguration=t=>{this.configuration=Object.assign(Object.assign({},this.configuration),t)},this.applyConfiguration=()=>{const t=this.sky.material.uniforms;t.turbidity.value=this.configuration.turbidity,t.rayleigh.value=this.configuration.rayleigh,t.mieCoefficient.value=this.configuration.mieCoefficient,t.mieDirectionalG.value=this.configuration.mieDirectionalG;const e=n.MathUtils.degToRad(90-this.configuration.elevation),i=n.MathUtils.degToRad(this.configuration.azimuth);this.sun.setFromSphericalCoords(1,e,i),t.sunPosition.value.copy(this.sun),this.renderer.toneMappingExposure=this.configuration.exposure,this.scene.environment=this.pmremGenerator.fromScene(this.sky).texture},this.update=()=>{this.configuration.azimuth=(this.configuration.azimuth+1)%360},this.configuration=Object.assign({turbidity:10,rayleigh:3,mieCoefficient:.005,mieDirectionalG:.7,elevation:1,azimuth:180,exposure:.5},s),this.sky.scale.setScalar(1e4),this.scene.add(this.sky)}}},436:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.updateChunkGeometry=e.loadImprovedTexture=e.loadMinimalTexture=void 0;const n=i(212);e.loadMinimalTexture=t=>{const e=(new n.TextureLoader).load("images/flourish-cc-by-nc-sa.png",t);return e.magFilter=n.NearestFilter,e.minFilter=n.NearestFilter,{material:new n.MeshStandardMaterial({map:e,side:n.DoubleSide,alphaTest:.1,transparent:!0}),tileSize:16,tileTextureWidth:256,tileTextureHeight:64,faces:[{uvRow:0,dir:[-1,0,0],corners:[{pos:[0,1,0],uv:[0,1]},{pos:[0,0,0],uv:[0,0]},{pos:[0,1,1],uv:[1,1]},{pos:[0,0,1],uv:[1,0]}]},{uvRow:0,dir:[1,0,0],corners:[{pos:[1,1,1],uv:[0,1]},{pos:[1,0,1],uv:[0,0]},{pos:[1,1,0],uv:[1,1]},{pos:[1,0,0],uv:[1,0]}]},{uvRow:1,dir:[0,-1,0],corners:[{pos:[1,0,1],uv:[1,0]},{pos:[0,0,1],uv:[0,0]},{pos:[1,0,0],uv:[1,1]},{pos:[0,0,0],uv:[0,1]}]},{uvRow:2,dir:[0,1,0],corners:[{pos:[0,1,1],uv:[1,1]},{pos:[1,1,1],uv:[0,1]},{pos:[0,1,0],uv:[1,0]},{pos:[1,1,0],uv:[0,0]}]},{uvRow:0,dir:[0,0,-1],corners:[{pos:[1,0,0],uv:[0,0]},{pos:[0,0,0],uv:[1,0]},{pos:[1,1,0],uv:[0,1]},{pos:[0,1,0],uv:[1,1]}]},{uvRow:0,dir:[0,0,1],corners:[{pos:[0,0,1],uv:[0,0]},{pos:[1,0,1],uv:[1,0]},{pos:[0,1,1],uv:[0,1]},{pos:[1,1,1],uv:[1,1]}]}]}};e.loadImprovedTexture=t=>{const e=(new n.TextureLoader).load("images/6524.png",t);return e.magFilter=n.NearestFilter,e.minFilter=n.NearestFilter,{material:new n.MeshStandardMaterial({map:e,side:n.DoubleSide,alphaTest:.1,transparent:!0}),tileSize:32,tileTextureWidth:512,tileTextureHeight:1024,faces:[{uvRow:0,dir:[-1,0,0],corners:[{pos:[0,1,0],uv:[0,1]},{pos:[0,0,0],uv:[0,0]},{pos:[0,1,1],uv:[1,1]},{pos:[0,0,1],uv:[1,0]}]},{uvRow:0,dir:[1,0,0],corners:[{pos:[1,1,1],uv:[0,1]},{pos:[1,0,1],uv:[0,0]},{pos:[1,1,0],uv:[1,1]},{pos:[1,0,0],uv:[1,0]}]},{uvRow:0,dir:[0,-1,0],corners:[{pos:[1,0,1],uv:[1,0]},{pos:[0,0,1],uv:[0,0]},{pos:[1,0,0],uv:[1,1]},{pos:[0,0,0],uv:[0,1]}]},{uvRow:0,dir:[0,1,0],corners:[{pos:[0,1,1],uv:[1,1]},{pos:[1,1,1],uv:[0,1]},{pos:[0,1,0],uv:[1,0]},{pos:[1,1,0],uv:[0,0]}]},{uvRow:0,dir:[0,0,-1],corners:[{pos:[1,0,0],uv:[0,0]},{pos:[0,0,0],uv:[1,0]},{pos:[1,1,0],uv:[0,1]},{pos:[0,1,0],uv:[1,1]}]},{uvRow:0,dir:[0,0,1],corners:[{pos:[0,0,1],uv:[0,0]},{pos:[1,0,1],uv:[1,0]},{pos:[0,1,1],uv:[0,1]},{pos:[1,1,1],uv:[1,1]}]}]}};e.updateChunkGeometry=(t,e,i,o,r,a,h)=>{const c=Math.floor(t/o),l=Math.floor(e/o),d=Math.floor(i/o),u=r.geometry,{positions:p,normals:g,uvs:v,indices:m}=s(c,l,d,o,a,h);u.setAttribute("position",new n.BufferAttribute(new Float32Array(p),3));u.setAttribute("normal",new n.BufferAttribute(new Float32Array(g),3));u.setAttribute("uv",new n.BufferAttribute(new Float32Array(v),2)),u.setIndex(m),u.computeBoundingSphere()};const s=(t,e,i,n,{tileSize:s,tileTextureWidth:o,tileTextureHeight:r,faces:a},h)=>{const c=[],l=[],d=[],u=[],p=t*n,g=e*n,v=i*n;for(let t=0;t<n;++t){const e=g+t;for(let i=0;i<n;++i){const g=v+i;for(let v=0;v<n;++v){const n=p+v,m=h({x:n,y:e,z:g});if(m){const p=m-1;for(const{dir:m,corners:w,uvRow:f}of a){if(!h({x:n+m[0],y:e+m[1],z:g+m[2]})){const e=c.length/3;for(const{pos:e,uv:n}of w)c.push(e[0]+v,e[1]+t,e[2]+i),l.push(...m),d.push((p+n[0])*s/o,1-(f+1-n[1])*s/r);u.push(e,e+1,e+2,e+2,e+1,e+3)}}}}}}return{positions:c,normals:l,uvs:d,indices:u}}},927:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.initUnit=e.UnitView=void 0;const n=i(212),s=i(661);class o{constructor(t,e,i,o){this.startMovingToward=(t,e=1)=>{var i;const o=this,r=[],a=[];t.forEach((({x:i,y:n,z:s},o)=>{o>0&&n-t[o-1].y>0?(r.push(t[o-1].x,n,t[o-1].z),a.push(a.length/e)):o>0&&n-t[o-1].y<0&&(r.push(i,t[o-1].y,s),a.push(a.length/e)),r.push(i,n,s),a.push(a.length/e)}));const h=new n.VectorKeyframeTrack(".position",a,r),c=new n.AnimationClip("move",-1,[h]),l=new n.AnimationMixer(o.mesh),d=r.slice(r.length-3);return o.mesh.position.set(d[0],d[1],d[2]),o.move=l.clipAction(c),o.move.setLoop(s.LoopOnce,0),null===(i=o.move)||void 0===i||i.play(),new Promise((t=>{l.addEventListener("finished",(()=>t()))}))},this.startAttacking=(t,e,i)=>{var o,r;const a=this;let h;if(e.isReady()){const t=e.computeAnimation();h=t.mixer,a.attack=t.action}else{const e=[a.mesh.position,t,a.mesh.position].flatMap((t=>[t.x,t.y,t.z])),s=[0,i/2,i],o=new n.VectorKeyframeTrack(".position",s,e),r=new n.AnimationClip("attack",-1,[o]);h=new n.AnimationMixer(a.mesh),a.attack=h.clipAction(r)}return null===(o=a.attack)||void 0===o||o.setLoop(s.LoopOnce,0),null===(r=a.attack)||void 0===r||r.play(),new Promise((t=>{h.addEventListener("finished",(()=>{e.clear(),t()}))}))},this.die=()=>{this.mesh.visible=!1},this.update=t=>{var e,i;this.idle.getMixer().update(t),null===(e=this.move)||void 0===e||e.getMixer().update(t),null===(i=this.attack)||void 0===i||i.getMixer().update(t)},this.mesh=i,this.unit=t,this.player=e;const r=new n.AnimationMixer(i);this.idle=r.clipAction(o),this.childrenIds=(t=>{let e=[],i=[],n=t;for(;n;)i.push(n.uuid),e.push(...n.children),n=e.shift();return i})(i)}}e.UnitView=o;e.initUnit=(t,e,i)=>"warrior"===t.type?r(t,e,i):a(t,e,i);const r=(t,e,i)=>{const s=new n.Mesh(new n.BoxGeometry(.5,.5,.5),new n.MeshStandardMaterial({roughness:0,color:i.color})),r=new n.Mesh;r.position.set(e.x,e.y,e.z),s.position.set(0,.5,0),r.add(s);const a=new n.Vector3(1,0,0),h=[(new n.Quaternion).setFromAxisAngle(a,0),(new n.Quaternion).setFromAxisAngle(a,Math.PI),(new n.Quaternion).setFromAxisAngle(a,2*Math.PI)].flatMap((t=>[t.x,t.y,t.z,t.w])),c=new n.QuaternionKeyframeTrack(".children[0].quaternion",[0,1,2],h),l=new n.AnimationClip("idle",-1,[c]);return new o(t,i,r,l)},a=(t,e,i)=>{const s=new n.Mesh(new n.BoxGeometry(.4,.4,.4),new n.MeshStandardMaterial({roughness:0,color:i.color})),r=new n.Mesh;r.position.set(e.x,e.y,e.z),s.position.set(0,.5,0),r.add(s);const a=new n.Vector3(0,1,0),h=[(new n.Quaternion).setFromAxisAngle(a,0),(new n.Quaternion).setFromAxisAngle(a,Math.PI),(new n.Quaternion).setFromAxisAngle(a,2*Math.PI)].flatMap((t=>[t.x,t.y,t.z,t.w])),c=new n.QuaternionKeyframeTrack(".children[0].quaternion",[0,.5,1],h),l=new n.AnimationClip("idle",-1,[c]);return new o(t,i,r,l)}},479:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.delay=e.toVector3=e.toScreenPosition=void 0;const n=i(212);e.toScreenPosition=(t,e,i)=>{const s=new n.Vector3;return t.updateMatrixWorld(),s.setFromMatrixPosition(t.matrixWorld),s.project(e),new n.Vector2(Math.round((s.x+1)*i.width/2),Math.round((1-s.y)*i.height/2))};e.toVector3=({x:t,y:e,z:i})=>new n.Vector3(t,e,i);e.delay=(t,e)=>new Promise((i=>{setTimeout((()=>i(t)),e)}))},193:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.TrajectoryView=e.RangeView=void 0;const n=i(212);e.RangeView=class{constructor(t){this.rangeLayer=new n.Group,this.draw=(t,e)=>{this.clear(),e.map((e=>((t,e)=>{const i=new n.Mesh(new n.BoxGeometry(1,.1,1),new n.MeshStandardMaterial({roughness:0,color:t,opacity:.4,transparent:!0}));return i.position.set(e.x,e.y-1,e.z),i})(t,e))).forEach((t=>this.rangeLayer.add(t)))},this.rangeLayer.position.set(.5,1,.5),t.add(this.rangeLayer)}clear(){this.rangeLayer.clear()}};e.TrajectoryView=class{constructor(){this.group=new n.Group,this.pNb=30,this.draw=(t,e,i)=>{const{pNb:s,group:o,clear:r}=this;r();const a=t.mesh.position,h=new n.Vector2(e.x-a.x,e.z-a.z),c=[];for(let t=0;t<s;t++){const e=new n.Mesh(new n.SphereGeometry(.1),new n.MeshStandardMaterial({roughness:0})),{x:o,y:r}=i.getPoint(t/s);e.position.set(o,r,0),c.push(e)}o.add(...c),t.mesh.add(o),o.rotation.y=-h.angle(),this.vectors=c.map((({position:t})=>t)),this.trajectory=i},this.computeAnimation=()=>{const{pNb:t,trajectory:e,group:i,vectors:s}=this;if(!e)throw new Error("No trajectory computed");const o=new n.Mesh(new n.SphereGeometry(.1),new n.MeshStandardMaterial({roughness:0}));i.clear(),i.add(o);const r=[],a=[];null==s||s.forEach((({x:i,y:n,z:s},o)=>{a.push(o*e.T/t),r.push(i,n,s)}));const h=new n.VectorKeyframeTrack(".position",a,r),c=new n.AnimationMixer(o);return{mixer:c,action:c.clipAction(new n.AnimationClip("launch",-1,[h]))}},this.update=t=>{var e;null===(e=this.launch)||void 0===e||e.getMixer().update(t)},this.clear=()=>{this.trajectory=void 0,this.group.clear(),this.group.removeFromParent()}}isReady(){return void 0!==this.trajectory}}},485:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.BasicWorldMapGenerator=void 0;const n=i(271),s=i(712),o=i(263),r=i(551);e.BasicWorldMapGenerator=class{constructor(t,e,i){this.length=t,this.width=e,this.maxHeight=i}generate(){const{length:t,width:e,maxHeight:i}=this,a=(0,n.generateTerrain)(t,e,4,2,1),h=new s.WorldMap(t,3),c=(0,r.randomInRange)(3,10);let l=[];for(let i=0;i<c;i++)l.push([(0,r.randomInRange)(0,t),(0,r.randomInRange)(0,e)]);const d=o.Delaunay.from(l).voronoi([0,0,e-1,t-1]);for(let n=0;n<e;++n)for(let e=0;e<t;++e){const t=a[e][n],s=Array.from(d.cellPolygons()).find((t=>d.contains(t.index,e,n)));for(let o=0;o<i;++o)s&&o<t&&h.setVoxel({x:e,y:o,z:n},1+s.index%3)}return h}}}},i={};function n(t){var s=i[t];if(void 0!==s)return s.exports;var o=i[t]={exports:{}};return e[t].call(o.exports,o,o.exports,n),o.exports}n.m=e,t=[],n.O=(e,i,s,o)=>{if(!i){var r=1/0;for(l=0;l<t.length;l++){for(var[i,s,o]=t[l],a=!0,h=0;h<i.length;h++)(!1&o||r>=o)&&Object.keys(n.O).every((t=>n.O[t](i[h])))?i.splice(h--,1):(a=!1,o<r&&(r=o));if(a){t.splice(l--,1);var c=s();void 0!==c&&(e=c)}}return e}o=o||0;for(var l=t.length;l>0&&t[l-1][2]>o;l--)t[l]=t[l-1];t[l]=[i,s,o]},n.d=(t,e)=>{for(var i in e)n.o(e,i)&&!n.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{var t={179:0};n.O.j=e=>0===t[e];var e=(e,i)=>{var s,o,[r,a,h]=i,c=0;if(r.some((e=>0!==t[e]))){for(s in a)n.o(a,s)&&(n.m[s]=a[s]);if(h)var l=h(n)}for(e&&e(i);c<r.length;c++)o=r[c],n.o(t,o)&&t[o]&&t[o][0](),t[r[c]]=0;return n.O(l)},i=self.webpackChunkthree_typescript_webpack_starter=self.webpackChunkthree_typescript_webpack_starter||[];i.forEach(e.bind(null,0)),i.push=e.bind(null,i.push.bind(i))})(),n.O(void 0,[963],(()=>n(607)));var s=n.O(void 0,[963],(()=>n(941)));s=n.O(s)})();